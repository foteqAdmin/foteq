<script type="text/javascript">
	function addRowToParticipantes()
	{
		parts++;

		var row = $("#table1 tr:last-child").clone();
		row.children()[0].firstChild.setAttribute("name","publicacao[participantes[nome"+parts+"]]");
		row.children()[0].firstChild.value = "";
		row.appendTo("#table1");
	}

	var parts;
	var oneHasNotBeenDeleted = true;

	$(document).ready(function()
	{
		var textParticipantes = $("#table1 tr:last-child").clone().children()[0].firstChild.getAttribute("name");
		parts = parseInt(textParticipantes[29]);

		$("#table1").on('mouseover', 'td#delete', function()
		{
			if (parts == 1)
				return;

			this.childNodes[1].style.visibility = 'visible';
		});

		$("#table1").on('mouseout', 'td#delete', function()
		{
			if (parts == 1)
				return;

			if (this.childNodes[1].style.visibility == 'visible')
				this.childNodes[1].style.visibility = 'hidden';
		});

		$("#table1").on('click', 'td#delete', function()
		{
			if (this.childNodes[1].style.visibility == 'hidden')
				return;
			else
			{
				var table = this.parentNode.parentNode.parentNode.getAttribute("id");

				var elemNumber = parseInt(this.parentNode.childNodes[1].childNodes[0].getAttribute("name")[29]);

				var rowNumber;
				if (table == "table1")
				{
					if (elemNumber < parts)
					{
						for (var i = 1;i<=parts;i++)
						{
							if (i > elemNumber)
							{
								rowNumber = i + 2;
									this.parentNode.parentNode.childNodes[rowNumber].childNodes[1].childNodes[0].setAttribute("name","publicacao[participantes[nome"+(i-1)+"]]");
							}							
						}
					}
					parts--;
				}

				var allNode = $(this).parent().parent().contents();
				alert(allNode.get());

				if (elemNumber == 1 && oneHasNotBeenDeleted)
				{
					$(allNode.get()[elemNumber + 1]).remove();
					oneHasNotBeenDeleted = false;
				}
				else
					$(allNode.get()[elemNumber + 2]).remove();
			}				
		});
	});
</script>
<% if @publicacao.errors.any? %>
  <div id="error_explanation" >
    <h5><%= pluralize(@publicacao.errors.count, "error") %>
    prohibited this publicação from being saved:</h5>
    <ul>
      <% @publicacao.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_tag({:controller => "publicacoes", :action => "create"}, :method => "post", :class => "new_publicacoe") do %>
  Título<br/>
  <%= text_field(:publicacao, :titulo) %><br/>
  Ano<br/>
  <%= text_field(:publicacao, :ano) %><br/>
  Título do periódico/revista em que foi publicado<br/>
  <%= text_field(:publicacao, :suporte) %><br/>
  Volume<br/>
  <%= text_field(:publicacao, :volume) %><br/>
  Página Inicial<br/>
  <%= text_field(:publicacao, :pag_ini) %><br/>
  Página Final<br/>
  <%= text_field(:publicacao, :pag_final) %><br/>
  Autores<br/>
  <%= fields_for(:publicacao, :participantes) do |part| %>
    <table id="table1">
      <tr>
        <th>Nome
        </th>

        <td><%= image_tag "plus.png", :size => '18x18', :style => 'cursor:pointer;', :title => 'Add participante', :onClick => 'addRowToParticipantes();' %>
        </td>      
      </tr>

      <% i = 0%>
      <% @publicacao.participantes.each do i=i+1%>
      <% end %>

      <% if i == 0 %>
        <% i = 2 %>
      <% end %>

      <% for j in 1..i/2%>

        <tr>
          <td><input name="publicacao[participantes[nome<%= j.to_s %>]]" value="<%= @publicacao.participantes['nome'+j.to_s] %>" size="20" type="text" />
          </td>
          <td id="delete">
            <img src='/assets/trash-icon.png' style="visibility:hidden;">
          </td>
        </tr>
      <% end %>
    </table>
  <% end %>
  <br/>
  <%= submit_tag %>
<% end %>
